<!doctype html>

<head>
    <title>Picot Canvas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link href="/static/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/fbarresi/PicotBrushApi/refs/heads/main/static/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .file-upload {
  background-color: #ffffff;
  /*width: 600px;*/
  margin: 0 auto;
  padding: 20px;
}


.file-upload-content {
  display: none;
  text-align: center;
}

.file-upload-input {
  position: absolute;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  outline: none;
  opacity: 0;
  cursor: pointer;
}

.image-upload-wrap {
  margin-top: 20px;
  border: 2px dashed #1FB264;
  position: relative;
}

.image-dropping,
.image-upload-wrap:hover {
  background-color: #1fb26499;
  border: 2px dashed #ffffff;
}

.image-title-wrap {
  padding: 0 15px 15px 15px;
  color: #222;
}

.drag-text {
  text-align: center;
}

.drag-text h3 {
  font-weight: 100;
  text-transform: uppercase;
  color: #15824B;
  padding: 60px 0;
}

.file-upload-image {
  max-height: 200px;
  max-width: 200px;
  margin: auto;
  padding: 20px;
}

footer {
    bottom: 0;
    width: 100%;
    white-space: nowrap;
    line-height: 60px;
}
    </style>
</head>
<html>

<body class="min-vh-100 vstack">
    <header>
        <nav class="navbar navbar-light bg-light">
            <a class="navbar-brand p-4" href="/">
                <img src="https://raw.githubusercontent.com/fbarresi/PicotBrushApi/refs/heads/main/static/images/paint_5015997.png" width="50" height="50" class="d-inline-block align-top mx-2" alt="">
                <span class="fs-4">Picot Canvas</span>
            </a>
            <ul class="nav col-12 col-md-auto mb-2 justify-content-center m-md-4">
                <li><a href="/" class="nav-link px-2 link-secondary">Home</a></li>
                <li><a href="wlan/" class="nav-link px-2 link-dark">Network</a></li>
                <li></li>
            </ul>
        </nav>
    </header>
    <main class="flex-grow-1">
        <div class="container">
            <div class="container-fluid">
                <div class="row">
                    <form>
                        <div class="px-2 py-2 my-1">
                            <p class="d-inline-flex gap-1">
                                <a class="btn btn-secondary btm-sm" data-bs-toggle="collapse" href="#settings" data-target="#settings" role="button" aria-expanded="false" aria-controls="settings">
                                    settings
                                </a>
                            </p>
                            <div class="collapse" id="settings">
                                <div class="card card-body">
                                    <div>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text" id="basic-addon1">Rotate:</span>
                                            <input type="number" min="0" max="270" step="90" value="0" data-bind="value:replyNumber" class="form-control" name="rotation" id="rotation"> <span class="input-group-text">deg</span>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text" id="basic-addon1">Size:</span>
                                            <input type="number" class="form-control" value="800" min="1" step="1" data-bind="value:replyNumber" aria-label="width" name="width" id="width" disabled>
                                            <span class="input-group-text">x</span>
                                            <input type="number" class="form-control" value="480" min="1" step="1" data-bind="value:replyNumber" aria-label="height" name="height" id="height" disabled>
                                            <span class="input-group-text">px</span>
                                        </div>
                                    </div>
                                    <div>
                                        <input class="form-check-input" type="checkbox" id="preserveAspectRatio" name="preserveAspectRatio" checked>
                                        <label class="form-check-label" for="preserveAspectRatio">Preserve aspect ratio</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="file-upload p-2 my-1 d-grid">
                            <button class="btn btn-success btn-lg" type="button" onclick="$('.file-upload-input').trigger( 'click' )">upload image</button>
                            <div class="image-upload-wrap">
                                <input class="file-upload-input" type='file' id="file" name="file" onchange="readURL(this);" accept="image/jpeg, image/png" required />
                                <div class="drag-text">
                                    <h3>Drag and drop a file here</h3>
                                </div>
                            </div>
                            <div class="file-upload-content">
                                <img class="file-upload-image" src="#" alt="your image" />
                                <div class="image-title-wrap">
                                    <button type="button" onclick="removeUpload()" class="btn btn-outline-danger">Remove <span class="image-title">Uploaded Image</span></button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="row collapse" id="redraw">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button onclick="rotate()" class="btn btn-primary" type="button">rotate</button>
                        <button onclick="draw()" class="btn btn-primary" type="button">redraw</button>
                    </div>
                </div>
                <div class="row collapse" id=results>
                    <div class="col p-4">
                        <p>preview:</p>
                        <img id="imageContainer" class="img-fluid" style="border: 1px dashed #000000;" alt="resulting image">
                    </div>
                    <div class="d-grid gap-2 p-4">
                        <button id="upload-image" onclick="getBinary()" class="btn btn-primary btn-lg" type="button">
                            <span class="spinner-border spinner-border-sm collapse" role="status" aria-hidden="true" id="loading-upload"></span>
                            upload image
                        </button>
                    </div>

                    <div class="d-grid gap-2 p-4">
                        <button id="update-canvas" onclick="display()" class="btn btn-success btn-lg" type="button">
                            <span class="spinner-border spinner-border-sm collapse" role="status" aria-hidden="true" id="loading-update"></span>
                            update canvas
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="d-grid gap-2 p-4">
                        <button id="clear-canvas" onclick="clear_canvas()" class="btn btn-warning btn-lg" type="button">
                            <span class="spinner-border spinner-border-sm collapse" role="status" aria-hidden="true" id="loading-clear"></span>
                            clear canvas
                        </button>
                    </div>
                    <div class="d-grid gap-2 p-4">
                        <button class="btn btn-light btn-lg" type="button" onclick="update_preview()">
                            toggle preview
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="collapse" id="preview">
                      <div class="card card-body">
                        <img id="imagePreviewContainer" class="img-fluid" style="border: 1px dashed #000000;" alt="resulting image" src="/static/image-preview.jpg">
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="text-center text-lg-start bg-body-tertiary text-muted mt-5">
        <div class="d-flex p-4 border-bottom">
            &copy; 2025 - <a href="https://github.com/fbarresi/PicotCanvas" class="px-2"><i class="bi bi-github"></i> Picot Canvas</a>
        </div>
    </footer>
    <script src="/static/jquery-3.7.1.min.js"></script>
    <script src="/static/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

    <script>

    var preview_blob = null;

    function readURL(input) {
        if (input.files && input.files[0]) {

            var reader = new FileReader();

            reader.onload = function(e) {
                $('.image-upload-wrap').hide();

                $('.file-upload-image').attr('src', e.target.result);
                $('.file-upload-content').show();

                $('.image-title').html(input.files[0].name);
            };

            reader.readAsDataURL(input.files[0]);

            draw();


        } else {
            removeUpload();
        }
    }

    function removeUpload() {
        $('.file-upload-input').replaceWith($('.file-upload-input').clone());
        $('.file-upload-content').hide();
        $('.image-upload-wrap').show();
        $('#results').hide();
        $('#redraw').hide();
    }

    $('.image-upload-wrap').bind('dragover', function() {
        $('.image-upload-wrap').addClass('image-dropping');
    });
    $('.image-upload-wrap').bind('dragleave', function() {
        $('.image-upload-wrap').removeClass('image-dropping');
    });

    function rotate() {
        var rot = Number($('#rotation').val());
        $('#rotation').val((rot+90)%360);
        draw();
    }


    function draw() {
        $('#redraw').show();
        var rotation = Number($('#rotation').val());
        var data = new FormData(jQuery('form')[0]);
        $.ajax({
            type: "POST",
            method: 'POST',
            enctype: 'multipart/form-data',
            url: "https://picotbrush.azurewebsites.net/paint",
            data: data,
            processData: false,
            contentType: false,
            cache: false,
            timeout: 600000,
            xhrFields: {
                responseType: 'blob' // treat the response as binary
            },

            success: function(blob) {

                preview_blob = blob;
                const imageUrl = URL.createObjectURL(blob);
                $('#imageContainer').attr('src', imageUrl);
                $('#results').show();
                $("html, body").animate({ scrollTop: $(document).height() }, 1000);

            },
            error: function(e) {

                //$("#result").text(e.responseText);
                console.log("ERROR : ", e);
                //$("#btnSubmit").prop("disabled", false);

            }
        });
    }

    function getBinary() {
        //var data = $('form').serialize();
        var data = new FormData(jQuery('form')[0]);
        $.ajax({
            type: "POST",
            method: 'POST',
            enctype: 'multipart/form-data',
            url: "https://picotbrush.azurewebsites.net/convert",
            data: data,
            processData: false,
            contentType: false,
            cache: false,
            timeout: 600000,
            xhrFields: {
                responseType: 'blob' // treat the response as binary
            },

            success: function(blob) {

                upload(blob);
                const binUrl = URL.createObjectURL(blob);
                console.log("SUCCESS : ", binUrl);
                upload_preview(preview_blob);

            },
            error: function(e) {
                console.log("ERROR : ", e);
            }
        });
    }

    function upload(blob) {
        $("#loading-upload").removeClass('collapse');
        const filename = "image.bin";
        $.ajax({
            url: '/upload/image',
            method: 'POST',
            type: "POST",
            data: blob,
            processData: false,
            contentType: false,
            headers: {
                'Content-Type': 'application/octet-stream',
                'Content-Disposition': `attachment; filename="${filename}"`,
            },
            success: function(data) {
                console.log('Upload accepted:', data);
                $("#loading-upload").addClass('collapse');
            }
        });
    }

     function upload_preview(blob) {
        const filename = "image-preview.jpg";
        $.ajax({
            url: '/upload/preview',
            method: 'POST',
            type: "POST",
            data: blob,
            processData: false,
            contentType: false,
            headers: {
                'Content-Type': 'application/octet-stream',
                'Content-Disposition': `attachment; filename="${filename}"`,
            },
            success: function(data) {
                console.log('Preview upload accepted:', data);
            }
        });
    }

    function display() {
        $("#loading-update").removeClass('collapse');
        $.ajax({
            url: '/update',
            method: 'GET',
            success: function(data) {
                console.log('Update done:', data);
                $("#loading-update").addClass('collapse');
            }
        });
    }

    function clear_canvas() {
        $("#loading-clear").removeClass('collapse');
        $.ajax({
            url: '/clear',
            method: 'GET',
            success: function(data) {
                console.log('clear done:', data);
                $("#loading-clear").addClass('collapse');
            }
        });

    }

    function update_preview() {
        $('#preview').toggle();
        $('#imagePreviewContainer').attr('src', '/static/image-preview.jpg?' + new Date().getTime());
    }
    </script>
</body>

</html>